# Scripts

## sync-export-docs.js

Pulls the markdown export-format docs from the **core** repo into the docs site so the vulnerability intelligence and IOC intelligence format docs stay in sync.

**Source:** `core/docs/exports/vuln_intel_format.md` and `core/docs/exports/ioc_intel_format.md`  
**Output:** `build/exports/vuln-intel-format.mdx` and `build/exports/ioc-intel-format.mdx`

### Usage

From the **mintlify-docs** repo root:

```bash
# Copy current export docs from core (core must be at ../core, or set CORE_DIR)
node scripts/sync-export-docs.js

# Regenerate vuln intel docs in core first, then copy (requires core repo with pdm)
node scripts/sync-export-docs.js --regenerate
```

### Options

- **`--regenerate`** – Run `pdm run python docs/exports/generate.py --output-dir docs/exports/` in the core repo before copying. Use this after changing vuln intel export models so the markdown is fresh. (IOC format doc is not generated by that script; it is copied as-is from core.)

### Environment

- **`CORE_DIR`** – Path to the core repo root (default: `../core` relative to mintlify-docs). Set this if core lives elsewhere, e.g. `CORE_DIR=/path/to/core node scripts/sync-export-docs.js`.

### When to run

- After pulling core changes that touch `core/docs/exports/` or vuln intel export models.
- Before publishing docs if you want the latest export format docs in the site.

---

## Updating the API Reference OpenAPI file

The docs site uses a **local** OpenAPI spec at `api-reference/openapi.json` so Mintlify deployment doesn’t depend on fetching `https://api.mallory.ai/openapi.json` at build time.

To refresh the API reference after API changes:

1. In the **core** repo, regenerate the public spec:
   ```bash
   pdm run python core/scripts/generate_openapi_doc.py
   ```
2. Copy the generated file into the docs repo:
   ```bash
   cp core/docs/openapi.json mintlify-docs/api-reference/openapi.json
   ```
3. Commit and push the updated `api-reference/openapi.json` in mintlify-docs.

Optionally, add a CI job in core that runs the generator and commits the result to mintlify-docs, or a script in mintlify-docs that runs the core generator and copies the file.

---

## notify-changelog-to-slack.js

When the changelog page (`changelog.mdx`) is updated, hashes the file and, if the hash changed, posts the latest timeline section to Slack (internal and community webhooks). Used in GitHub Actions so that updates to the changelog trigger a notification to the two changelog channels.

**Flow:** Hash `changelog.mdx` → compare to stored hash in `scripts/.changelog-hash` → if different (or `--force`): extract latest month section, POST to both webhooks, write new hash to `scripts/.changelog-hash`.

### Usage

From the **mintlify-docs** repo root:

```bash
# Post to Slack only if changelog content changed since last run
node scripts/notify-changelog-to-slack.js

# Post even if hash unchanged (e.g. to re-send latest section)
node scripts/notify-changelog-to-slack.js --force
```

### Environment

- **`INTERNAL_SLACK_WEBHOOK`** – Incoming webhook URL for internal #changelog.
- **`COMMUNITY_SLACK_WEBHOOK`** – Incoming webhook URL for community changelog.
- **`CHANGELOG_HASH_FILE`** – Optional path to file storing last content hash (default: `scripts/.changelog-hash`).

### GitHub Actions

Add a workflow that runs on push (e.g. to `main`) when `changelog.mdx` changes:

1. Run `node scripts/notify-changelog-to-slack.js` with the two webhook secrets set.
2. If the script updates the hash file, commit and push `scripts/.changelog-hash` so the next run does not re-post the same content.

Example job step:

```yaml
- name: Notify Slack on changelog update
  env:
    INTERNAL_SLACK_WEBHOOK: ${{ secrets.INTERNAL_SLACK_WEBHOOK }}
    COMMUNITY_SLACK_WEBHOOK: ${{ secrets.COMMUNITY_SLACK_WEBHOOK }}
  run: node scripts/notify-changelog-to-slack.js
# Optional: commit updated .changelog-hash if it changed
```

You can use a conditional step to commit only when `scripts/.changelog-hash` was modified.
